<!DOCTYPE html>

<html>
<head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>MuseMe</title>
        <link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>
        <h1 id="title">Click to Listen...</h1>
        <button id="myBtn">Date</button>
        <p id = "demo"></p>
        <button onclick="startRecording(this);">record</button>
        <button onclick="stopRecording(this);" name="aaa" disabled>stop</button>

        <p><img src="playbutton.jpg" border="0" alt="Playbutton" id="playbutton"/></p>
        <p id = "playing"></p>

        <h2>Recordings</h2>
        <ul id="recordingslist"></ul>

        <h2>Log</h2>
        <pre id="log"></pre>

        <script>

        var song;
        var hf;
                
        function __log(e, data) {
                        log.innerHTML += "\n" + e + " " + (data || '');
                }

                var audio_context;
                var recorder;

                function startUserMedia(stream) {
                        var input = audio_context.createMediaStreamSource(stream);
                        __log('Media stream created.');
                // Uncomment if you want the audio to feedback directly
                //input.connect(audio_context.destination);
                //__log('Input connected to audio context destination.');

                recorder = new Recorder(input);
                __log('Recorder initialised.');
        }

        function startRecording(button) {
                recorder && recorder.record();
                button.disabled = true;
                button.nextElementSibling.disabled = false;
                __log('Recording...');
        }

        function stopRecording(button) {
          recorder && recorder.stop();
          button.disabled = true;
          button.previousElementSibling.disabled = false;
          __log('Stopped recording.');

                // create WAV download link using audio data blob
                // 

                createDownloadLink();
                // var xhr = new XMLHttpRequest();
                // // xhr.onreadystatechange = function() {
                // //     if (this.readyState == 4 && this.status == 200) {
                // //         output = JSON.parse(xhr.responseText)
                // //         for (var i = 0; i < output.length; i++){
                // //             document.getElementById("output").innerHTML += output[i] + "</br>"
                // //         }
                // //     }
                // // }
                // xhr.open("POST", "/musicin", true);
                // xhr.setRequestHeader("Content-Type", "audio/mpeg");
                // xhr.send(song);

                recorder.clear();
        }   

        function createDownloadLink() {
                var au;
                recorder && recorder.exportWAV(function(blob) {
                // var url = URL.createObjectURL(blob);
                // var li = document.createElement('li');
                // au = document.createElement('audio');
                // hf = document.createElement('a');
                console.log(blob)
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/musicin", true);
                // 
                xhr.setRequestHeader("Content-Type", "audio/wav");
                
                xhr.onreadystatechange = function() {
                    console.log("DONE")
                }
                
                // var formData = new FormData();

                // formData.append("thefile", blob);
                // xhr.send(formData);

                xhr.send(blob);
                // au.controls = true;
                // au.src = url;
                // hf.href = url;

                // hf.download = new Date().toISOString() + '.wav';

                // hf.download = 'sample.wav';
                // hf.innerHTML = hf.download;
                // li.appendChild(au);
                // li.appendChild(hf);
                // recordingslist.appendChild(li);
                });

                // var ffm = require('ffmpeg');
                // var process = new ffmpeg('record.html');
                // process.then(function (au) {
                //     au.fnExtractSoundToMP3('record.html', function(error, file){
                //     });
                // })

                // return au;
        }

        window.onload = function init() {
                try {
                        // webkit shim
                        window.AudioContext = window.AudioContext || window.webkitAudioContext;
                        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
                        window.URL = window.URL || window.webkitURL;
                        
                        audio_context = new AudioContext;
                        __log('Audio context set up.');
                        __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
                } catch (e) {
                        alert('No web audio support in this browser!');
                }

        navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
                __log('No live audio input: ' + e);
        });
        };
        </script>

<script src="recorder_plugin.js"></script>
<script src="index.js"></script>
<!-- <script type="module" src="acr.js"></script> -->

</body>
</html>